
# SeqEditor — Application Documentation

Graphical application for defining a simple sequential logic DSL (`.seq`), validating syntax,
generating equivalent Arduino `.ino` code, and compiling/flashing to ATmega32u4 boards
(Adafruit ItsyBitsy 32u4 5V) via `arduino-cli`.

This app uses **CustomTkinter**, **subprocess**, and a small logic parser to provide an
end‑to‑end code → microcontroller workflow.

---

## Overview

`seq_editor.py` provides:

1. **Hardware configuration UI**
   - Arduino port detection  
   - Device FQBN selection  
   - Sketch directory selection

2. **Clock configuration**
   - Internal vs external clock  
   - Clock pin selection  
   - Frequency slider  
   - Clock LED mirroring

3. **Code editor**
   - Multi‑line text box for writing `.seq` logic
   - Buttons: **New**, **Open**, **Save**, **Check**, **Flash**

4. **Syntax checking**
   - Pin declarations (`pin <name> = <number>`)
   - Combinational logic (`X = AND(A, B)`)
   - Sequential logic (`Q1.D = NOT(A)`)
   - Function arity enforcement (`NOT 1 param`, `AND/OR/XOR 2 params`)
   - Symbol validation and undefined‑name detection

5. **Code generation**
   - Translates `.seq` logic into C++ code inside an Arduino `.ino` sketch
   - Inserts clock configuration from GUI
   - Writes `seq_sketch.ino` into `<SketchDir>/seq_sketch/`

6. **Integration with Arduino CLI**
   - `compile` and `upload` subprocess calls
   - Uses detected port and user‑specified FQBN

---

## GUI Layout Summary

### Hardware Section
- **Port:** auto‑filled from `arduino-cli board list`
- **Device:** default `"adafruit:avr:itsybitsy32u4_5V"`
- **SketchDir:** directory where `.ino` + `isrClock.h` will live

### Clock Section
- Radio buttons: **Internal** / **External**
- Combobox: Clock pin (1–4)
- Checkbox: LED mirror
- Frequency slider (1–10 Hz)

### Code Section
- Multi‑line `CTkTextbox` for `.seq` DSL
- Buttons:
  - **New**: clears editor
  - **Open**: opens `.seq` file
  - **Save**: writes `.seq` file
  - **Check**: run syntax verification
  - **Flash**: generate `.ino`, compile, upload

### Error Box
- A logging pane displaying check‑results, flash status, compile errors, etc.

---

## `.seq` DSL Summary

### Pin definition
```
pin <name> = <number>
PIN A = 3
pin Y2=8
```

Rules:
- `<name>` must start with a letter
- May contain letters, numbers, `_`

### Combinational logic
```
Y = AND(A, Q1)
Z = NOT(Y)
```

Allowed functions:
```
NOT(x)
AND(x, y)
OR(x, y)
XOR(x, y)
```

### Sequential logic
```
Q1.D = AND(A, B)
Q2.D = NOT(Q1)
```

Rules:
- Left-hand side must be `Q*` or `q*`
- `.D` is mandatory
- Q variables are stored and updated on clock rising edges

### Symbol rules
- Symbols may appear before definition
- But the checker enforces:
  - **pins must be defined**  
  - **aux variables must appear in an assignment before use**

---

## Core Internal Functions

### `check_seq_code()`
Runs the syntax and semantic validation. Steps:

1. Read textbox content.
2. Split into lines.
3. First pass: validate grammar and build symbol tables.
4. Second pass: ensure referenced symbols exist.
5. Report first error in error box.
6. Enable Flash if no errors.

Errors detected:
- Missing `=`
- Missing `.D` for sequential statements
- Wrong function arity
- Undefined symbols
- Invalid pin declaration
- Invalid identifier format

---

### `_generate_ino_source()`
Builds the full `.ino` sketch:

1. Insert clock config  
2. Add header include  
3. Predeclare pin and Q variables  
4. Convert combinational expressions into C++  
5. Insert sequential update block inside rising‑edge handler

Output is written to:
```
<SketchDir>/seq_sketch/seq_sketch.ino
```

---

### `_prepare_sketch_dir()`
Ensures:

- A valid `SketchDir` exists  
- A subdirectory `seq_sketch/` is created  
- `isrClock.h` is copied into it  

---

### `_initial_board_scan()`
Runs:

```
arduino-cli board list --format json
```

Selects the **USB** port over generic serial ports.  
Populates the Port entry automatically.

---

### `on_flash()`
Full pipeline:

1. Validate environment
2. Generate `.ino`
3. Write file
4. Compile:

```
arduino-cli compile --fqbn <device> <sketch_dir>
```

5. Upload:

```
arduino-cli upload -p <port> --fqbn <device> <sketch_dir>
```

6. Log results in error box

---

## File Structure Used by Application

```
SeqEditor/
  seq_editor.py
  isrClock.h
  images/
    app_ui.png
  dist/            (ignored, not versioned)
  build/           (ignored)
```

Generated by Flash:

```
<SketchDir>/
  isrClock.h
  seq_sketch/
    seq_sketch.ino
```

---

## Limitations & Future Improvements

- No backtracking parser; DSL is line‑oriented only.
- Single‑clock domain (one clock pin).
- No parenthesis nesting beyond function calls.
- No multi‑output logic in one statement.
- Arduino CLI errors are only displayed, not parsed.

---


